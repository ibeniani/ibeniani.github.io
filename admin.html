<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - FastFix 72</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="loginSection" class="container mt-5">
        <h2>Connexion Admin</h2>
        <form id="loginForm">
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Mot de passe</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Se connecter</button>
        </form>
        <p id="loginError" class="text-danger mt-3" style="display:none;"></p>
    </div>

    <div id="adminSection" style="display:none;" class="container mt-5">
        <h2>Dashboard Admin</h2>
        <button id="logoutBtn" class="btn btn-danger mb-3">Se déconnecter</button>
        
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="clients-tab" data-bs-toggle="tab" href="#clients" role="tab">Clients</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="repairs-tab" data-bs-toggle="tab" href="#repairs" role="tab">Réparations</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="sales-tab" data-bs-toggle="tab" href="#sales" role="tab">Annonces Ventes</a>
            </li>
        </ul>
        
        <div class="tab-content" id="adminTabContent">
            <!-- Onglet Clients -->
            <div class="tab-pane fade show active" id="clients" role="tabpanel">
                <h3>Ajouter un Client</h3>
                <form id="addClientForm">
                    <div class="row">
                        <div class="col-md-3"><input type="text" class="form-control" placeholder="Nom" id="clientNom" required></div>
                        <div class="col-md-3"><input type="text" class="form-control" placeholder="Prénom" id="clientPrenom" required></div>
                        <div class="col-md-3"><input type="tel" class="form-control" placeholder="Téléphone" id="clientTel" required></div>
                        <div class="col-md-3"><input type="text" class="form-control" placeholder="Modèle Téléphone" id="clientModel" required></div>
                    </div>
                    <button type="submit" class="btn btn-success mt-3">Ajouter Client</button>
                </form>
                <h3 class="mt-4">Liste des Clients</h3>
                <input type="text" id="searchClients" class="form-control mb-3" placeholder="Rechercher par nom...">
                <table class="table table-striped" id="clientsTable">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Téléphone</th>
                            <th>Modèle Téléphone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody"></tbody>
                </table>
            </div>
            
            <!-- Onglet Réparations -->
            <div class="tab-pane fade" id="repairs" role="tabpanel">
                <h3>Ajouter une Réparation</h3>
                <form id="addRepairForm">
                    <select class="form-control mb-3" id="repairClient" required>
                        <option value="">Sélectionner un client</option>
                    </select>
                    <input type="text" class="form-control mb-3" placeholder="Problème" id="repairProblem" required>
                    <input type="date" class="form-control mb-3" id="repairDate" required>
                    <select class="form-control mb-3" id="repairStatus">
                        <option value="En attente">En attente</option>
                        <option value="En cours">En cours</option>
                        <option value="Terminée">Terminée</option>
                    </select>
                    <button type="submit" class="btn btn-success">Ajouter Réparation</button>
                </form>
                <h3 class="mt-4">Liste des Réparations</h3>
                <table class="table table-striped" id="repairsTable">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Problème</th>
                            <th>Date</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="repairsTableBody"></tbody>
                </table>
            </div>
            
            <!-- Onglet Annonces Ventes -->
            <div class="tab-pane fade" id="sales" role="tabpanel">
                <h3>Ajouter une Annonce</h3>
                <form id="addSaleForm">
                    <input type="text" class="form-control mb-3" placeholder="Modèle (ex. iPhone 12)" id="saleModel" required>
                    <input type="number" class="form-control mb-3" placeholder="Prix (€)" id="salePrice" required>
                    <textarea class="form-control mb-3" placeholder="Description" id="saleDesc" required></textarea>
                    <input type="url" class="form-control mb-3" placeholder="URL Image" id="saleImage" required>
                    <button type="submit" class="btn btn-success">Publier Annonce</button>
                </form>
                <h3 class="mt-4">Annonces Actives</h3>
                <table class="table table-striped" id="salesTable">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Modèle</th>
                            <th>Prix</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals pour modification -->
    <!-- Modal Client -->
    <div class="modal fade" id="editClientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="editClientNom" placeholder="Nom">
                    <input type="text" class="form-control mb-3" id="editClientPrenom" placeholder="Prénom">
                    <input type="tel" class="form-control mb-3" id="editClientTel" placeholder="Téléphone">
                    <input type="text" class="form-control mb-3" id="editClientModel" placeholder="Modèle Téléphone">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveClientBtn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Réparation -->
    <div class="modal fade" id="editRepairModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier Réparation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <select class="form-control mb-3" id="editRepairClient">
                        <option value="">Sélectionner un client</option>
                    </select>
                    <input type="text" class="form-control mb-3" id="editRepairProblem" placeholder="Problème">
                    <input type="date" class="form-control mb-3" id="editRepairDate">
                    <select class="form-control mb-3" id="editRepairStatus">
                        <option value="En attente">En attente</option>
                        <option value="En cours">En cours</option>
                        <option value="Terminée">Terminée</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveRepairBtn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Vente -->
    <div class="modal fade" id="editSaleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier Annonce</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="editSaleModel" placeholder="Modèle">
                    <input type="number" class="form-control mb-3" id="editSalePrice" placeholder="Prix (€)">
                    <textarea class="form-control mb-3" id="editSaleDesc" placeholder="Description"></textarea>
                    <input type="url" class="form-control mb-3" id="editSaleImage" placeholder="URL Image">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveSaleBtn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCYboBQuUWjos9q0M6bD6GSuQ09Se29t9o",
            authDomain: "fastfix72-45e6b.firebaseapp.com",
            projectId: "fastfix72-45e6b",
            storageBucket: "fastfix72-45e6b.firebasestorage.app",
            messagingSenderId: "90073792848",
            appId: "1:90073792848:web:b4992b9265b1ba0cc9ac55",
            measurementId: "G-60F64PQP29"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        console.log('Firebase initialized');

        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginSection = document.getElementById('loginSection');
        const adminSection = document.getElementById('adminSection');
        const loginError = document.getElementById('loginError');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Login form submitted');
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log('Login successful');
                loginSection.style.display = 'none';
                adminSection.style.display = 'block';
                loadData();
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Erreur : ' + error.message;
                loginError.style.display = 'block';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await auth.signOut();
            loginSection.style.display = 'block';
            adminSection.style.display = 'none';
        });

        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User logged in:', user.email);
                loginSection.style.display = 'none';
                adminSection.style.display = 'block';
                loadData();
            } else {
                console.log('No user logged in');
                loginSection.style.display = 'block';
                adminSection.style.display = 'none';
            }
        });

        async function loadData() {
            try {
                await loadClients();
                await loadRepairs();
                await loadSales();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadClients() {
            const clientsTableBody = document.getElementById('clientsTableBody');
            clientsTableBody.innerHTML = '';
            const querySnapshot = await db.collection('clients').get();
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.nom}</td>
                    <td>${data.prenom}</td>
                    <td>${data.tel}</td>
                    <td>${data.model}</td>
                    <td>
                        <button class="btn btn-warning btn-sm me-2" onclick="editClient('${doc.id}', '${data.nom}', '${data.prenom}', '${data.tel}', '${data.model}')">Modifier</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClient('${doc.id}')">Supprimer</button>
                    </td>
                `;
                clientsTableBody.appendChild(row);
            });
            // Peupler les selects
            const repairClientSelect = document.getElementById('repairClient');
            const editRepairClientSelect = document.getElementById('editRepairClient');
            repairClientSelect.innerHTML = '<option value="">Sélectionner un client</option>';
            editRepairClientSelect.innerHTML = '<option value="">Sélectionner un client</option>';
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const option1 = document.createElement('option');
                option1.value = doc.id;
                option1.textContent = `${data.nom} ${data.prenom}`;
                repairClientSelect.appendChild(option1);
                const option2 = option1.cloneNode(true);
                editRepairClientSelect.appendChild(option2);
            });
        }

        async function loadRepairs() {
            const repairsTableBody = document.getElementById('repairsTableBody');
            repairsTableBody.innerHTML = '';
            const querySnapshot = await db.collection('repairs').get();
            for (const doc of querySnapshot.docs) {
                const data = doc.data();
                let clientName = 'Client inconnu';
                try {
                    const clientDoc = await db.collection('clients').doc(data.clientId).get();
                    if (clientDoc.exists) {
                        const clientData = clientDoc.data();
                        clientName = `${clientData.nom} ${clientData.prenom}`;
                    }
                } catch (error) {
                    console.error('Error fetching client:', error);
                }
                const statusBadge = data.status === 'En attente' ? 'badge bg-warning' : data.status === 'En cours' ? 'badge bg-danger' : 'badge bg-success';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${clientName}</td>
                    <td>${data.problem}</td>
                    <td>${data.date}</td>
                    <td><span class="${statusBadge}">${data.status}</span></td>
                    <td>
                        <button class="btn btn-warning btn-sm me-2" onclick="editRepair('${doc.id}', '${data.clientId}', '${data.problem}', '${data.date}', '${data.status}')">Modifier</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteRepair('${doc.id}')">Supprimer</button>
                    </td>
                `;
                repairsTableBody.appendChild(row);
            }
        }

        async function loadSales() {
            const salesTableBody = document.getElementById('salesTableBody');
            salesTableBody.innerHTML = '';
            const querySnapshot = await db.collection('sales').get();
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${data.image}" alt="${data.model}" style="width: 50px; height: 50px; cursor: pointer;" onclick="window.open('${data.image}', '_blank')"></td>
                    <td>${data.model}</td>
                    <td>${data.price}€</td>
                    <td>${data.desc}</td>
                    <td>
                        <button class="btn btn-warning btn-sm me-2" onclick="editSale('${doc.id}', '${data.model}', '${data.price}', '${data.desc}', '${data.image}')">Modifier</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSale('${doc.id}')">Supprimer</button>
                    </td>
                `;
                salesTableBody.appendChild(row);
            });
        }

        // Barre de recherche pour clients
        document.getElementById('searchClients').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#clientsTableBody tr');
            rows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                row.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        });

        document.getElementById('addClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const nom = document.getElementById('clientNom').value;
                const prenom = document.getElementById('clientPrenom').value;
                const tel = document.getElementById('clientTel').value;
                const model = document.getElementById('clientModel').value;
                await db.collection('clients').add({ nom, prenom, tel, model });
                loadClients();
                e.target.reset();
            } catch (error) {
                console.error('Error adding client:', error);
                alert('Erreur lors de l\'ajout du client : ' + error.message);
            }
        });

        document.getElementById('addRepairForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const clientId = document.getElementById('repairClient').value;
                const problem = document.getElementById('repairProblem').value;
                const date = document.getElementById('repairDate').value;
                const status = document.getElementById('repairStatus').value;
                await db.collection('repairs').add({ clientId, problem, date, status });
                loadRepairs();
                e.target.reset();
            } catch (error) {
                console.error('Error adding repair:', error);
                alert('Erreur lors de l\'ajout de la réparation : ' + error.message);
            }
        });

        document.getElementById('addSaleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const model = document.getElementById('saleModel').value;
                const price = document.getElementById('salePrice').value;
                const desc = document.getElementById('saleDesc').value;
                const image = document.getElementById('saleImage').value;
                await db.collection('sales').add({ model, price, desc, image });
                loadSales();
                e.target.reset();
            } catch (error) {
                console.error('Error adding sale:', error);
                alert('Erreur lors de l\'ajout de l\'annonce : ' + error.message);
            }
        });

        // Fonctions de suppression
        window.deleteClient = async (id) => {
            if (confirm('Supprimer ce client ?')) {
                try {
                    await db.collection('clients').doc(id).delete();
                    loadClients();
                } catch (error) {
                    console.error('Error deleting client:', error);
                    alert('Erreur lors de la suppression : ' + error.message);
                }
            }
        };

        window.deleteRepair = async (id) => {
            if (confirm('Supprimer cette réparation ?')) {
                try {
                    await db.collection('repairs').doc(id).delete();
                    loadRepairs();
                } catch (error) {
                    console.error('Error deleting repair:', error);
                    alert('Erreur lors de la suppression : ' + error.message);
                }
            }
        };

        window.deleteSale = async (id) => {
            if (confirm('Supprimer cette annonce ?')) {
                try {
                    await db.collection('sales').doc(id).delete();
                    loadSales();
                } catch (error) {
                    console.error('Error deleting sale:', error);
                    alert('Erreur lors de la suppression : ' + error.message);
                }
            }
        };

        // Fonctions de modification
        window.editClient = (id, nom, prenom, tel, model) => {
            document.getElementById('editClientNom').value = nom;
            document.getElementById('editClientPrenom').value = prenom;
            document.getElementById('editClientTel').value = tel;
            document.getElementById('editClientModel').value = model;
            const modal = new bootstrap.Modal(document.getElementById('editClientModal'));
            modal.show();
            document.getElementById('saveClientBtn').onclick = async () => {
                try {
                    await db.collection('clients').doc(id).update({
                        nom: document.getElementById('editClientNom').value,
                        prenom: document.getElementById('editClientPrenom').value,
                        tel: document.getElementById('editClientTel').value,
                        model: document.getElementById('editClientModel').value
                    });
                    modal.hide();
                    loadClients();
                } catch (error) {
                    console.error('Error updating client:', error);
                    alert('Erreur lors de la modification : ' + error.message);
                }
            };
        };

        window.editRepair = (id, clientId, problem, date, status) => {
            document.getElementById('editRepairClient').value = clientId;
            document.getElementById('editRepairProblem').value = problem;
            document.getElementById('editRepairDate').value = date;
            document.getElementById('editRepairStatus').value = status;
            const modal = new bootstrap.Modal(document.getElementById('editRepairModal'));
            modal.show();
            document.getElementById('saveRepairBtn').onclick = async () => {
                try {
                    await db.collection('repairs').doc(id).update({
                        clientId: document.getElementById('editRepairClient').value,
                        problem: document.getElementById('editRepairProblem').value,
                        date: document.getElementById('editRepairDate').value,
                        status: document.getElementById('editRepairStatus').value
                    });
                    modal.hide();
                    loadRepairs();
                } catch (error) {
                    console.error('Error updating repair:', error);
                    alert('Erreur lors de la modification : ' + error.message);
                }
            };
        };

        window.editSale = (id, model, price, desc, image) => {
            document.getElementById('editSaleModel').value = model;
            document.getElementById('editSalePrice').value = price;
            document.getElementById('editSaleDesc').value = desc;
            document.getElementById('editSaleImage').value = image;
            const modal = new bootstrap.Modal(document.getElementById('editSaleModal'));
            modal.show();
            document.getElementById('saveSaleBtn').onclick = async () => {
                try {
                    await db.collection('sales').doc(id).update({
                        model: document.getElementById('editSaleModel').value,
                        price: document.getElementById('editSalePrice').value,
                        desc: document.getElementById('editSaleDesc').value,
                        image: document.getElementById('editSaleImage').value
                    });
                    modal.hide();
                    loadSales();
                } catch (error) {
                    console.error('Error updating sale:', error);
                    alert('Erreur lors de la modification : ' + error.message);
                }
            };
        };
    </script>
</body>
</html>


<!--  

       const firebaseConfig = {
            apiKey: "AIzaSyCYboBQuUWjos9q0M6bD6GSuQ09Se29t9o",
            authDomain: "fastfix72-45e6b.firebaseapp.com",
            projectId: "fastfix72-45e6b",
            storageBucket: "fastfix72-45e6b.firebasestorage.app",
            messagingSenderId: "90073792848",
            appId: "1:90073792848:web:b4992b9265b1ba0cc9ac55",
            measurementId: "G-60F64PQP29"
        };

-->
